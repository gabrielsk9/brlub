    SELECT 
            F8_FILIAL,
            F8_DTDIGIT,
            F8_NFDIFRE,
            F8_SEDIFRE,
            F8_TRANSP,
            F8_LOJTRAN,
            NOME_TRANSP,
            CIDADE_TRANSP,
            F8_NFORIG,
            F8_SERORIG,
            F8_FORNECE,
            F8_LOJA,
            NOME_FORNECE,
            CIDADE_FORNECE,
            CHV_CTE,
            VAL_CTE,
            CHV_NFE,
            VAL_NFE,
            PES_BRUTO,
            PES_TOTAL,
            VAL_MERC_TOTAL,
           ROUND(VAL_NFE / VAL_MERC_TOTAL * VAL_CTE,2) FRETE_VALOR_PROPORCIONAL,
           ROUND(VAL_CTE / VAL_MERC_TOTAL  * 100,2) PERCENTUAL_FRETE,
       CASE WHEN PES_TOTAL > 0 THEN  ROUND(VAL_CTE / PES_TOTAL * 1000,2) ELSE 0 END FRETE_TONELADA
  FROM (
SELECT  F8.F8_FILIAL,
        F8.F8_DTDIGIT,
        F8.F8_NFDIFRE,
        F8.F8_SEDIFRE,
        F8.F8_TRANSP,
        F8.F8_LOJTRAN,
        A21.A2_NREDUZ NOME_TRANSP,
        A21.A2_MUN CIDADE_TRANSP,
        F8.F8_NFORIG,
        F8.F8_SERORIG,
        F8.F8_FORNECE,
        F8.F8_LOJA,
        A22.A2_NREDUZ NOME_FORNECE,
        A22.A2_MUN CIDADE_FORNECE,
       F1A.F1_CHVNFE CHV_CTE,
       F1A.F1_VALBRUT VAL_CTE,
       F1B.F1_CHVNFE CHV_NFE,
       F1B.F1_VALBRUT VAL_NFE,
       F1B.F1_PBRUTO PES_BRUTO,
       (SELECT SUM(F1_PBRUTO)
          FROM C8O7DN_135098_PR_PD.dbo.SF8140 F81
         INNER JOIN C8O7DN_135098_PR_PD.dbo.SF1140 F13
            ON F13.D_E_L_E_T_ = ' '
           AND F13.F1_SERIE = F81.F8_SERORIG
           AND F13.F1_DOC = F81.F8_NFORIG
           AND F13.F1_LOJA = F81.F8_LOJA
           AND F13.F1_FORNECE = F81.F8_FORNECE
           AND F13.F1_FILIAL = F81.F8_FILIAL
         WHERE F81.D_E_L_E_T_ =' '
           AND F81.F8_NFDIFRE = F8.F8_NFDIFRE
           AND F81.F8_SEDIFRE = F8.F8_SEDIFRE
           AND F81.F8_TRANSP = F8.F8_TRANSP
           AND F81.F8_LOJTRAN = F8.F8_LOJTRAN
           AND F81.F8_FILIAL = F8.F8_FILIAL) PES_TOTAL,
       (SELECT SUM(F1_VALBRUT)
          FROM C8O7DN_135098_PR_PD.dbo.SF8140 F81
         INNER JOIN C8O7DN_135098_PR_PD.dbo.SF1140 F13
            ON F13.D_E_L_E_T_ = ' '
           AND F13.F1_SERIE = F81.F8_SERORIG
           AND F13.F1_DOC = F81.F8_NFORIG
           AND F13.F1_LOJA = F81.F8_LOJA
           AND F13.F1_FORNECE = F81.F8_FORNECE
           AND F13.F1_FILIAL = F81.F8_FILIAL
         WHERE F81.D_E_L_E_T_ =' '
           AND F81.F8_NFDIFRE = F8.F8_NFDIFRE
           AND F81.F8_SEDIFRE = F8.F8_SEDIFRE
           AND F81.F8_TRANSP = F8.F8_TRANSP
           AND F81.F8_LOJTRAN = F8.F8_LOJTRAN
           AND F81.F8_FILIAL = F8.F8_FILIAL) VAL_MERC_TOTAL
  FROM C8O7DN_135098_PR_PD.dbo.SF8140 F8
 INNER JOIN C8O7DN_135098_PR_PD.dbo.SF1140 F1A
    ON F1A.D_E_L_E_T_ = ' '
   AND F1A.F1_SERIE = F8.F8_SEDIFRE
   AND F1A.F1_DOC = F8.F8_NFDIFRE
   AND F1A.F1_LOJA = F8.F8_LOJTRAN
   AND F1A.F1_FORNECE = F8.F8_TRANSP
   AND F1A.F1_FILIAL = F8.F8_FILIAL
 INNER JOIN C8O7DN_135098_PR_PD.dbo.SF1140 F1B
    ON F1B.D_E_L_E_T_ = ' '
   AND F1B.F1_SERIE = F8.F8_SERORIG
   AND F1B.F1_DOC = F8.F8_NFORIG
   AND F1B.F1_LOJA = F8.F8_LOJA
   AND F1B.F1_FORNECE = F8.F8_FORNECE
   AND F1B.F1_FILIAL = F8.F8_FILIAL
 INNER JOIN C8O7DN_135098_PR_PD.dbo.SA2140 A21
    ON A21.D_E_L_E_T_ =' '
   AND A21.A2_COD = F8.F8_TRANSP
   AND A21.A2_LOJA = F8.F8_LOJTRAN
   AND A21.A2_FILIAL = '  '
 INNER JOIN C8O7DN_135098_PR_PD.dbo.SA2140 A22
    ON A22.D_E_L_E_T_ =' '
   AND A22.A2_COD = F8.F8_FORNECE
   AND A22.A2_LOJA = F8.F8_LOJA
   AND A22.A2_FILIAL = '  '
 WHERE F8.D_E_L_E_T_ =' '
   AND F8.F8_DTDIGIT >= convert(varchar, GETDATE()-731, 112)  ) TBL

